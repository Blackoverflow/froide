{% extends "admin/change_form.html" %}

{% block extrahead %}{{ block.super }}
<script>
    window.django.jQuery(function(){
        var $ = window.django.jQuery;
        var left = null;
        var top = null;
        var width = null;
        var height = null;
        var pageRect = $('#page_rect')
        var image = $('#page_image');
        var naturalWidth = image[0].naturalWidth
        var naturalHeight = image[0].naturalHeight
        image.on('load', function(){
            naturalWidth = image[0].naturalWidth
            naturalHeight = image[0].naturalHeight
        })
        image.on('mousedown', function(e) {
            if (left !== null) {
                var offsetWidth = image[0].offsetWidth
                var offsetHeight = image[0].offsetHeight
                var ratioX = naturalWidth / offsetWidth
                var ratioY = naturalHeight / offsetHeight
                $('#id_left').val(Math.round(left * ratioX))
                $('#id_top').val(Math.round(top * ratioY))
                var w = Math.round((e.offsetX - left) * ratioX)
                var h = Math.round((e.offsetY - top) * ratioY)
                $('#id_width').val(w)
                $('#id_height').val(h)

                left = null
                top = null
                return
            }
            left = e.offsetX
            top = e.offsetY
            pageRect.css('left', left)
            pageRect.css('top', top)
            pageRect.css('width', left)
            pageRect.css('height', top)

        })
        image.on('mousemove', function(e) {
            if (left === null) {
                return
            }
            pageRect.css('width', e.offsetX - left)
            pageRect.css('height', e.offsetY - top)
        })
    });
</script>
{% endblock %}

{% block after_field_sets %}
    {% if original and original.page %}
        <div style="position:relative; width: 100%">
            <img src="{{ original.page.image.url }}" alt="Testing" id="page_image" style="outline: 1px solid #000; width: 100%;">
            <div id="page_rect" style="outline: 1px solid #f00; position: absolute; pointer-events: none;"></div>
        </div>
    {% endif %}
{% endblock %}
